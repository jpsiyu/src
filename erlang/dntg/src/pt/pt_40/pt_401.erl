%% --------------------------------------------------------
%% @Module:           |pt_401
%% @Author:           |Wu Zhenhua
%% @Email:            |45517168@qq.com
%% @Created:          |2012-00-00
%% @Description:      |帮派协议_帮派场景内相关功能
%% --------------------------------------------------------

-module(pt_401).
-export([read/2, write/2]).
-include("record.hrl").
-include("guild.hrl").

-define(SEPARATOR_STRING, "【】").

%%%=========================================================================
%%% 解包函数_read 
%%%=========================================================================

%% -----------------------------------------------------------------
%% 召开宴会
%% -----------------------------------------------------------------
read(40100, <<Type:8>>) ->
    {ok, [Type]};

%% -----------------------------------------------------------------
%% 召开宴会
%% -----------------------------------------------------------------
read(40101, <<PlayerId:32, GuildId:32, Type:8, Start_Time:32>>) ->
    {ok, [PlayerId, GuildId, Type, Start_Time]};

%% -----------------------------------------------------------------
%% 获取技能列表
%% -----------------------------------------------------------------
read(40102, _) ->
    {ok, get_skill_list};

%% -----------------------------------------------------------------
%% 使用宴会技能
%% -----------------------------------------------------------------
read(40103, <<Skill_Id:32, Target_PlayerId:32>>) ->
    {ok, [Skill_Id, Target_PlayerId]};

%% -----------------------------------------------------------------
%% 使用宴会气氛物品
%% -----------------------------------------------------------------
read(40105, <<GoodsType_Id:32>>) ->
    {ok, [GoodsType_Id]};

%% -----------------------------------------------------------------
%% 传音发送信息
%%     Int32	帮派ID
%%     Int32	角色ID
%%     string	角色名
%%     string	标题
%%     string	内容
%% -----------------------------------------------------------------
read(40106, <<GuildId:32, PlayerId:32, Bin/binary>>) ->
	{PlayerName, Bin1} = pt:read_string(Bin),
	{Title, Bin2} = pt:read_string(Bin1),
	{Content, _} = pt:read_string(Bin2),
    {ok, [GuildId, PlayerId, PlayerName, Title, Content]};

%% -----------------------------------------------------------------
%% 查询宴会记录
%% -----------------------------------------------------------------
read(40107, <<G_Id:32>>) ->
    {ok, [G_Id]};

%% -----------------------------------------------------------------
%% 帮宴传音
%% -----------------------------------------------------------------
read(40111, <<GuildId:32, PlayerId:32, Bin/binary>>) ->
	{Content, _} = pt:read_string(Bin),
    {ok, [GuildId, PlayerId, Content]};

%% -----------------------------------------------------------------
%% 宴会答谢
%% -----------------------------------------------------------------
read(40113, _) ->
    {ok, 40113};

%% -----------------------------------------------------------------
%% 查看答谢信息 
%% -----------------------------------------------------------------
read(40114, _) ->
    {ok, check_thank_gift};

%% -----------------------------------------------------------------
%% 升级宴会 
%% -----------------------------------------------------------------
read(40116, _) ->
    {ok, ok};

%% -----------------------------------------------------------------
%% 帮派神兽基本信息
%% -----------------------------------------------------------------
read(40120, <<GuildId:32>>) ->
    {ok, [GuildId]};

%% -----------------------------------------------------------------
%% 帮派神兽升级
%% -----------------------------------------------------------------
read(40121, <<GuildId:32, Type:8, StartTime:16, HType:16>>) ->
    {ok, [GuildId, Type, StartTime, HType]};

%% -----------------------------------------------------------------
%% 帮派神兽召唤时间查询
%% -----------------------------------------------------------------
read(40122, _) ->
    {ok, ok};

%% -----------------------------------------------------------------
%% 获取神兽战剩余时间
%% -----------------------------------------------------------------
read(40130, _) ->
    {ok, ok};

%% -----------------------------------------------------------------
%% 获取神兽战斗结束(开始抽奖通知)
%% -----------------------------------------------------------------
%% read(40131, <<K:32>>) ->
%%     {ok, ok};

%% -----------------------------------------------------------------
%% ROLL点
%% -----------------------------------------------------------------
read(40132, <<PackId:16>>) ->
    {ok, [PackId]};

%% -----------------------------------------------------------------
%% 奖励分配结果
%% -----------------------------------------------------------------
%% read(40133, <<K:32>>) ->
%%     {ok, ok};

%% -----------------------------------------------------------------
%% 获取技能列表
%% -----------------------------------------------------------------
read(40127, _) ->
    {ok, ok};

%% -----------------------------------------------------------------
%% 获取技能列表
%% -----------------------------------------------------------------
read(40198, _) ->
    {ok, ok};

%% -----------------------------------------------------------------
%% 判断神兽雕像
%% -----------------------------------------------------------------
read(40199, Info) ->
    {ok, [Info]};

%% -----------------------------------------------------------------
%% 错误处理
%% -----------------------------------------------------------------
read(_Cmd, _R) ->
    {error, no_match}.

%%%=========================================================================
%%% 组包函数_write
%%%=========================================================================

%% -----------------------------------------------------------------
%% 进入帮派场景
%% -----------------------------------------------------------------
write(40100, [Type, Res]) ->
    {ok, pt:pack(40100, <<Type:8, Res:8>>)};

%% -----------------------------------------------------------------
%% 召开宴会
%% -----------------------------------------------------------------
write(40101, [Res]) ->
    {ok, pt:pack(40101, <<Res:8>>)};

%% -----------------------------------------------------------------
%% 获取技能列表
%% -----------------------------------------------------------------
write(40102, [Res, SkillList]) ->
	Bin = pack_40102(SkillList),
    {ok, pt:pack(40102, <<Res:8, Bin/binary>>)};

%% -----------------------------------------------------------------
%% 使用宴会技能
%% -----------------------------------------------------------------
write(40103, [Res]) ->
    {ok, pt:pack(40103, <<Res:8>>)};

%% -----------------------------------------------------------------
%% 被使用宴会技能
%% -----------------------------------------------------------------
write(40104, [Skill_Id, From_PlayerId]) ->
    {ok, pt:pack(40104, <<Skill_Id:32, From_PlayerId:32>>)};

%% -----------------------------------------------------------------
%% 使用宴会气氛物品
%% -----------------------------------------------------------------
write(40105, [Res, PlayerId, GoodsTypeId, Type, MoodAdd]) ->
    {ok, pt:pack(40105, <<Res:8, PlayerId:32, GoodsTypeId:32, Type:8, MoodAdd:16>>)};

%% -----------------------------------------------------------------
%% 享用宴会物品
%% -----------------------------------------------------------------
write(40106, [Res, PlayerName, Title, Content]) ->
	Bin_PlayerName = pt:write_string(PlayerName),
	Bin_Title = pt:write_string(Title),
	Bin_Content = pt:write_string(Content),
    {ok, pt:pack(40106, <<Res:8, Bin_PlayerName/binary, Bin_Title/binary, Bin_Content/binary>>)};

%% -----------------------------------------------------------------
%% 查询宴会记录
%% -----------------------------------------------------------------
write(40107, [Res, Time, SponsorId, SponsorName]) ->
	Bin_SponsorName = pt:write_string(SponsorName),
    {ok, pt:pack(40107, <<Res:8, Time:32, SponsorId:32, Bin_SponsorName/binary>>)};

%% -----------------------------------------------------------------
%% 宴会过程信息
%% -----------------------------------------------------------------
write(40108, [Time_Left, Mood, InfoType, Info, JoinNum, All_Exp, All_Llpt, Upgrader, PartyType]) ->
	Bin_Info = pt:write_string(Info),
	Bin_Upgrader = pt:write_string(Upgrader),
    {ok, pt:pack(40108, <<Time_Left:32, Mood:32, InfoType:16, Bin_Info/binary,
			JoinNum:16, All_Exp:32, All_Llpt:32,Bin_Upgrader/binary,PartyType:8>>)};

%% 刷新食物通知
write(40109, [])->
    Data = <<>>,
    {ok, pt:pack(40109, Data)};

%% -----------------------------------------------------------------
%% 帮宴传音
%% -----------------------------------------------------------------
write(40111, [Res]) ->
    {ok, pt:pack(40111, <<Res:8>>)};

%% -----------------------------------------------------------------
%% 帮宴结束公告
%% -----------------------------------------------------------------
write(40112, []) ->
	Data = <<>>,
    {ok, pt:pack(40112, Data)};

%% -----------------------------------------------------------------
%% 宴会答谢
%% -----------------------------------------------------------------
write(40113, [Res, Time]) ->
    {ok, pt:pack(40113, <<Res:8, Time:16>>)};

%% -----------------------------------------------------------------
%% 查看答谢信息
%% -----------------------------------------------------------------
write(40114, [Num, Type, LLPT, Name]) ->
	BinName = pt:write_string(Name),
    {ok, pt:pack(40114, <<Num:16, Type:8, LLPT:32, BinName/binary>>)};

%% -----------------------------------------------------------------
%% 刷新侍女
%% -----------------------------------------------------------------
write(40115, [Type]) ->
    {ok, pt:pack(40115, <<Type:8>>)};

%% -----------------------------------------------------------------
%% 升级宴会
%% -----------------------------------------------------------------
write(40116, [Res]) ->
    {ok, pt:pack(40116, <<Res:8>>)};

%% -----------------------------------------------------------------
%% 帮派神兽基本信息
%% -----------------------------------------------------------------
write(40120, [GodAnimal_Id, GodAnimal_Lv, GodAnimalExp, GodAnimalExp_Limit, Can_Kill_Today, LvUp_Cost_Coin, Call_Cost_Coin, Call_Cost_Money, Prize_List]) ->
	Bin_Prize_List = pack_40120(Prize_List),
    {ok, pt:pack(40120, <<GodAnimal_Id:32
						  , GodAnimal_Lv:16
							, GodAnimalExp:32
							  , GodAnimalExp_Limit:32
								, Can_Kill_Today:16
								  , LvUp_Cost_Coin:32
							  		, Call_Cost_Coin:32
									  , Call_Cost_Money:32
									  	, Bin_Prize_List/binary>>)};

%% -----------------------------------------------------------------
%% 神兽升级
%% -----------------------------------------------------------------
write(40121, [Res, Time]) ->
    {ok, pt:pack(40121, <<Res:8, Time:16>>)};

%% -----------------------------------------------------------------
%% 帮派神兽召唤时间查询
%% -----------------------------------------------------------------
write(40122, [Res, Time]) ->
    {ok, pt:pack(40122, <<Res:8, Time:16>>)};

%% -----------------------------------------------------------------
%% 获取神兽战剩余时间
%% -----------------------------------------------------------------
write(40130, [Res, Time]) ->
    {ok, pt:pack(40130, <<Res:8, Time:32>>)};

%% -----------------------------------------------------------------
%% 神兽战斗排行榜信息_
%% -----------------------------------------------------------------
write(40124, [DamageRank_Self, MakeDamage_Self, Damege_Percent, G_Rank]) ->
	Bin_G_Rank = pack_40124(G_Rank),
    {ok, pt:pack(40124, <<DamageRank_Self:16, MakeDamage_Self:32, Damege_Percent:16, Bin_G_Rank/binary>>)};

%% -----------------------------------------------------------------
%% 神兽_战斗结束_参战者
%% -----------------------------------------------------------------
write(40125, [Res]) ->
    {ok, pt:pack(40125, <<Res:8>>)};

%% -----------------------------------------------------------------
%% 神兽_战斗结束_未参战者
%% -----------------------------------------------------------------
write(40126, [Res, GA_Level, PT]) ->
    {ok, pt:pack(40126, <<Res:8, GA_Level:16, PT:8>>)};

%% -----------------------------------------------------------------
%% 神兽成长记录
%% -----------------------------------------------------------------
write(40127, [List]) ->
	Bin = pack_40127(List),
    {ok, pt:pack(40127, Bin)};

%% -----------------------------------------------------------------
%% 神兽经验奖励告示
%% -----------------------------------------------------------------
write(40128, [ExpAdd, Dm, Pm]) ->
    {ok, pt:pack(40128, <<ExpAdd:32, Dm:32, Pm:16>>)};

%% -----------------------------------------------------------------
%%  获取神兽战斗结束(开始抽奖通知)
%% -----------------------------------------------------------------

write(40131, [List, Num]) ->
	Data = pack_40131(List),
    {ok, pt:pack(40131, <<Data/binary, Num:16>>)};

%% -----------------------------------------------------------------
%% ROLL点
%% -----------------------------------------------------------------

write(40132, [Res, PackId, ExpAdd]) ->
    {ok, pt:pack(40132, <<Res:8, PackId:16, ExpAdd:32>>)};

%% -----------------------------------------------------------------
%% ROLL点结束
%% -----------------------------------------------------------------

write(40133, [List, Num]) ->
	Data = pack_40133(List),
    {ok, pt:pack(40133, <<Data/binary, Num:16>>)};

%% -----------------------------------------------------------------
%% 超过采集限制
%% -----------------------------------------------------------------
write(40197, [Res]) ->
    {ok, pt:pack(40197, <<Res:8>>)};

%% -----------------------------------------------------------------
%% 刷新帮派神兽雕像
%% -----------------------------------------------------------------
write(40199, [Res]) ->
    {ok, pt:pack(40199, <<Res:8>>)};

%% -----------------------------------------------------------------
%% 错误处理
%% -----------------------------------------------------------------
write(_Cmd, _R) ->
    {ok, pt:pack(0, <<>>)}.


%% -----------------------------------------------------------------------------
%% *****************************************************************************
%% 		 打包区_对各种内容比较复杂的协议进行打包
%% *****************************************************************************
%% -----------------------------------------------------------------------------

%% -----------------------------------------------------------------
%% 打包40102
%% -----------------------------------------------------------------
pack_40102([]) ->
    <<0:16, <<>>/binary>>;
pack_40102(List) ->
    Rlen = length(List),
    RB = list_to_binary([<<D:32>> || D <- List]),
    <<Rlen:16, RB/binary>>.

%% -----------------------------------------------------------------
%% 打包40120
%% -----------------------------------------------------------------
pack_40120([]) ->
    <<0:16, <<>>/binary>>;
pack_40120(List) ->
    Rlen = length(List),
    RB = list_to_binary([<<D:32>> || D <- List]),
    <<Rlen:16, RB/binary>>.

%% -----------------------------------------------------------------
%% 打包40124
%% -----------------------------------------------------------------
pack_40124([]) ->
    <<0:16, <<>>/binary>>;
pack_40124(List) ->
    Rlen = length(List),
	F = fun([Rank_Level, PlayerId, MakeDamage, Damage_Percent]) ->
        		<<Rank_Level:16, PlayerId:32, MakeDamage:32, Damage_Percent:16>>
    end,
    RB = list_to_binary([F(D) || D <- List]),
    <<Rlen:16, RB/binary>>.

%% -----------------------------------------------------------------
%% 打包40127
%% -----------------------------------------------------------------
pack_40127([]) ->
    <<0:16, <<>>/binary>>;
pack_40127(List) ->
    Rlen = length(List),
	F = fun(InfoD) ->
				case InfoD of
					[PlayerId, PlayerName, TaskId, ColorId, ExpAdd] ->
						Bin_PlayerName = pt:write_string(util:make_sure_list(PlayerName)),
	        			<<PlayerId:32, Bin_PlayerName/binary, TaskId:16, ColorId:16, ExpAdd:16>>;
					[PlayerId, TaskId, ColorId, ExpAdd] -> %% 针对旧数据的容错处理
						PlayerName = mod_disperse:call_to_unite(lib_appointment, get_partner_name, [PlayerId]),
						Bin_PlayerName = pt:write_string(util:make_sure_list(PlayerName)),
						<<PlayerId:32, Bin_PlayerName/binary, TaskId:16, ColorId:16, ExpAdd:16>>
				end
    end,
    RB = list_to_binary([F(D) || D <- List]),
    <<Rlen:16, RB/binary>>.

%% -----------------------------------------------------------------
%% 打包40131
%% -----------------------------------------------------------------
pack_40131([]) ->
    <<0:16, <<>>/binary>>;
pack_40131(List) ->
    Rlen = length(List),
    F = fun([PackId, LiBaoId]) ->
        <<PackId:16, LiBaoId:32>>
    end,
    RB = list_to_binary([F(D) || D <- List]),
    <<Rlen:16, RB/binary>>.

%% -----------------------------------------------------------------
%% 打包40133
%% -----------------------------------------------------------------
pack_40133([]) ->
    <<0:16, <<>>/binary>>;
pack_40133(List) ->
    Rlen = length(List),
    F = fun([PackId, LiBaoId, PlayerId, PlayerName, Point]) ->
		Bin_PlayerName = pt:write_string(PlayerName),
        <<PackId:16, LiBaoId:32, PlayerId:32, Bin_PlayerName/binary, Point:32>>
    end,
    RB = list_to_binary([F(D) || D <- List]),
    <<Rlen:16, RB/binary>>.


%% %% -----------------------------------------------------------------
%% %% 打包40114
%% %% -----------------------------------------------------------------
%% pack_40114([]) ->
%%     <<0:16, <<>>/binary>>;
%% pack_40114(List) ->
%%     Rlen = length(List),
%%     F = fun([PlayerId, PlayerName, Type, Content]) ->
%%         Bin_PlayerName = pt:write_string(PlayerName),
%%         <<PlayerId:32, Bin_PlayerName/binary, Type:8, Content:16>>
%%     end,
%%     RB = list_to_binary([F(D) || D <- List]),
%%     <<Rlen:16, RB/binary>>.
